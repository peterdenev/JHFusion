!function(a,b){"function"==typeof define&&define.amd?define("JHFusion",[],b):"object"==typeof exports?module.exports=b():a.JHFusion=b()}(this,function(){function b(b){var c=a++,d={attr_pfx:"data-",instance_pfx:c,observeHandler:Object.observe||function(){},unobserveHandler:Object.unobserve||function(){}};d.modelPatternHandler=function(a,b,c){var d=(b||"").split(";");for(var e in d){var f=d[e].trim().split(" ").map(function(a){return a.trim()}).filter(function(a){return""!=a});if(1==f.length&&(f.push("<<>"),f.push(f[0]),f[0]="val"),f.length>2&&""!=f[2]){var g=f[0].split(":").map(function(a){return a.trim()});1==g.length&&(g.push(g[0]),g[0]="change");var h=g[0].split(",").map(function(a){return a.trim()}),i=(f[1].match(/</g)||[]).length,j=(f[1].match(/>/g)||[]).length,k=2==i?"html":2==j?"js":null;c(function(a,b){var c=["val","html","text"];return{varName:b[2],canRead:i>0,canWrite:j>0,initCopyTo:k,ons:h,valueFromHTML:function(){return-1!=c.indexOf(g[1])?a[g[1]]():a.attr(g[1])},valueToHTML:function(b){return-1!=c.indexOf(g[1])?a[g[1]](b):(a.attr(g[1],b),void 0)}}}(a,f))}}},$.extend(d,b);var e=0,f={},g=!1,h=[];this.getOptions=function(){return d};var i=function(a,b,c,e,f){f="undefined"!=typeof f?f:!1;var g=function(a){for(var d in a)if(-1!==b.indexOf(a[d].name)&&(c.apply(this,e),f))break};return d.observeHandler(a,g),g},j=function(a,b,c){var e=!1,f=(b.attr(d.attr_pfx+"triggers")||"").split(",").map(function(a){return a.trim()}).filter(function(a){return"!"==a?(e=!0,!1):!0}),j=m(a,b.attr(d.attr_pfx+"handler")||"");if(j){var k=i(a,f,j,[a,b]);c.jsChangeHandler=k,e&&(g?h.push({handler:j,args:[a,b]}):j(a,b))}},k=function(a,b,c){b.each(function(){$.each(this.attributes,function(){if(this.specified&&0==this.name.indexOf(d.attr_pfx+"on")){var e=this.value.split("("),f=[];e.length>1&&(f=e[1].split(")")[0].trim().split(",").map(function(a){return a.trim()}));var g=this.name.substr((d.attr_pfx+"on").length);c.ons.hasOwnProperty(g)||(c.ons[g]=[]);var h=function(){m(a,e[0].trim()).apply(this,f)};c.ons[g].push(h),b.on(g,h)}})})};this.bindOne=function(a,b,c){var g=b.attr(d.attr_pfx+"bind-id");return("undefined"==typeof g||c)&&("undefined"==typeof g&&(g=d.instance_pfx+"_"+e++,b.attr(d.attr_pfx+"bind-id",g)),c&&f.hasOwnProperty(g)&&this.clearHandlers(g),f[g]={scope:a,ref_el:b,observeHandlers:[],ons:{change:[]},jsChangeHandler:void 0},d.modelPatternHandler(b,b.attr(d.attr_pfx+"models"),function(c){var e=function(){n(c.varName,c.valueFromHTML(),a)};switch(c.initCopyTo){case"js":e();break;case"html":c.valueToHTML(m(a,c.varName))}if(c.canRead){var h=function(b){for(var d in b)b[d].name==c.varName&&c.valueToHTML(m(a,c.varName))};f[g].observeHandlers.push(h),d.observeHandler(a,h)}if(c.canWrite)for(var i in c.ons){var j=c.ons[i];f[g].ons.hasOwnProperty(j)||(f[g].ons[j]=[]),f[g].ons[j].push(e),b.on(j,e)}}),j(a,b,f[g]),k(a,b,f[g])),g},this.bindHtml=function(a,b,c){c="undefined"!=typeof c?c:!0,b="undefined"!=typeof b?b:$("body");var e=[],f=this;return $(b).find("["+d.attr_pfx+"models]").each(function(){e.push(f.bindOne(a,$(this),c))}),e},this.fill=function(a){return $(a.el).attr(d.attr_pfx+"models",a.models),$(a.el).attr(d.attr_pfx+"triggers",a.triggers),$(a.el).attr(d.attr_pfx+"handler",a.handler),this.bindOne(a.scope,a.el)};var l=function(a){var b=a.toString();return b=b.substr("function ".length),b=b.substr(0,b.indexOf("(")),b.trim()};this.controllers=function(a){for(var b in a){var c=a[b],d=l(c);this.controller(d,c)}},this.controller=function(a,b){var c=$("["+d.attr_pfx+'controller="'+a+'"]');if(c.length){g=!0;var e=b({}),f=this.bindHtml(e,c);for(var i in h)h[i].handler.apply(null,h[i].args);g=!1,e.hasOwnProperty("init")&&e.init.apply(e,[f])}},this.clearHandlers=function(a){if(-1!=["number","string"].indexOf(a)&&(a=[a]),"object"==typeof a)for(var b in a){var c=a[b],e=f[c].scope,g=f[c].ref_el;for(var h in f[c].observeHandlers){var i=f[c].observeHandlers[h];d.unobserveHandler(e,i)}for(var j in f[c].ons)g.off(j);f[c].jsChangeHandler&&d.unobserveHandler(e,f[c].jsChangeHandler),delete f[c]}};var m=function(a,b){b=b.replace(/\[(\w+)\]/g,".$1"),b=b.replace(/^\./,"");for(var c=b.split(".");c.length;){var d=c.shift();if(!(d in a))return;a=a[d]}return a},n=function(a,b,c){c||(c=data);var d=a.split(/\./);d.length<2?c[d[0]]=b:(c[d[0]]||(c[d[0]]={}),c=c[d.shift()],n(d.join("."),b,c))}}var a=0;return b});