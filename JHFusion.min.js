!function(a,b){"function"==typeof define&&define.amd?define("JHFusion",[],b):"object"==typeof exports?module.exports=b():a.JHFusion=b()}(this,function(){function b(b){var c=a++,d={attr_pfx:"data-",instance_pfx:c,observeHandler:Object.observe||function(){},unobserveHandler:Object.unobserve||function(){}};d.mappingHandler=function(a,b,c){var d=(b||"").split(";");for(var e in d){var f=d[e].trim().split(" ").map(function(a){return a.trim()}).filter(function(a){return""!=a});if(1==f.length&&(f.push("<<>"),f.push(f[0]),f[0]="val"),f.length>2&&""!=f[2]){var g=f[0].split(":").map(function(a){return a.trim()});1==g.length&&(g.push(g[0]),g[0]="change");var h=g[0].split(",").map(function(a){return a.trim()}),i=(f[1].match(/</g)||[]).length,j=(f[1].match(/>/g)||[]).length,k=2==i?"html":2==j?"js":null;c(function(a,b,c){var d=["val","html","text"];return{varName:b[2],canRead:i>0,canWrite:j>0,initCopyTo:k,ons:h,valueFromHTML:function(){return-1!=d.indexOf(c[1])?a[c[1]]():a.attr(c[1])},valueToHTML:function(b){return-1!=d.indexOf(c[1])?a[c[1]](b):(a.attr(c[1],b),void 0)}}}(a,f,g))}}},$.extend(d,b);var e=0,f={complex:[]},g=!1,h=[];this.getOptions=function(){return d};var i=function(a,b,c){b.each(function(){$.each(this.attributes,function(){if(this.specified&&0==this.name.indexOf(d.attr_pfx+"on")){var e=this.value.split("("),f=[];e.length>1&&(f=e[1].split(")")[0].trim().split(",").map(function(a){return a=a.trim(),"this"==a?b:a}));var g=this.name.substr((d.attr_pfx+"on").length);c.ons.hasOwnProperty(g)||(c.ons[g]=[]);var h=function(){var b={scope:a,on:this.name};k(a,e[0].trim()).apply(b,f)};c.ons[g].push(h),b.on(g,h)}})})};this.bindOne=function(a,b,c){var g=b.attr(d.attr_pfx+"bind-id");return("undefined"==typeof g||c)&&("undefined"==typeof g&&(g=d.instance_pfx+"_"+e++,b.attr(d.attr_pfx+"bind-id",g)),c&&f.hasOwnProperty(g)&&this.clearHandlers(g),f[g]={scope:a,ref_el:b,observeHandlers:[],ons:{change:[]}},d.mappingHandler(b,b.attr(d.attr_pfx+"map"),function(c){var e=function(){l(c.varName,c.valueFromHTML(),a)},h=function(a){"function"==typeof a&&(a=a.apply(this,[])),c.valueToHTML(a)};switch(c.initCopyTo){case"js":e();break;case"html":h(k(a,c.varName))}if(c.canRead){var i=function(b){for(var d in b)b[d].name==c.varName&&h(k(a,c.varName))};f[g].observeHandlers.push(i),d.observeHandler(a,i)}if(c.canWrite)for(var j in c.ons){var m=c.ons[j];f[g].ons.hasOwnProperty(m)||(f[g].ons[m]=[]),f[g].ons[m].push(e),b.on(m,e)}}),i(a,b,f[g])),g},this.bindHtml=function(a,b,c){c="undefined"!=typeof c?c:!0,b="undefined"!=typeof b?b:$("body");var e=[],f=this;return $(b).find("["+d.attr_pfx+"map]").each(function(){e.push(f.bindOne(a,$(this),c))}),e},this.complex=function(a,b,c,e,i,j){j="undefined"!=typeof j?j:!1;var k=function(){var c=e.apply(a,i);b&&l(b,c,a)},m=function(a){for(var b in a)if(-1!==c.indexOf(a[b].name)&&(k(),j))break};f.complex.push({scope:a,varName:b,deps:c,handler:m}),d.observeHandler(a,m),-1!=c.indexOf("!")&&(g?h.push({handler:k,args:[]}):k())},this.fill=function(a){return $(a.el).attr(d.attr_pfx+"map",a.map),this.bindOne(a.scope,a.el)};var j=function(a){var b=a.toString();return b=b.substr("function ".length),b=b.substr(0,b.indexOf("(")),b.trim()};this.controllers=function(a){for(var b in a){var c=a[b],d=j(c);this.controller(d,c)}},this.controller=function(a,b){var c=$("["+d.attr_pfx+'controller="'+a+'"]');if(c.length){g=!0;var e=b({});if(e.hasOwnProperty("_complex"))for(var f in e._complex){var i=e._complex[f];this.complex(e,f,i[0],i[1],i[2],i[3])}var j=this.bindHtml(e,c);for(var k in h)h[k].handler.apply(null,h[k].args);g=!1,e.hasOwnProperty("init")&&e.init.apply(e,[j])}},this.clearHandlers=function(a){if(-1!=["number","string"].indexOf(a)&&(a=[a]),"object"==typeof a)for(var b in a){var c=a[b],e=f[c].scope,g=f[c].ref_el;for(var h in f[c].observeHandlers){var i=f[c].observeHandlers[h];d.unobserveHandler(e,i)}for(var j in f[c].ons)g.off(j);delete f[c]}};var k=function(a,b){b=b.replace(/\[(\w+)\]/g,".$1"),b=b.replace(/^\./,"");for(var c=b.split(".");c.length;){var d=c.shift();if(!(d in a))return;a=a[d]}return a},l=function(a,b,c){c||(c=data);var d=a.split(/\./);d.length<2?c[d[0]]=b:(c[d[0]]||(c[d[0]]={}),c=c[d.shift()],l(d.join("."),b,c))}}var a=0;return b});