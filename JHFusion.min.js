!function(a,b){"function"==typeof define&&define.amd?define("JHFusion",[],b):"object"==typeof exports?module.exports=b():a.JHFusion=b()}(this,function(){function a(a){var b={attr_pfx:"data-",observeHandler:Object.observe||function(){},unobserveHandler:Object.unobserve||function(){}};$.extend(b,a);var c=0,d={},e=!1,f=[];this.getOptions=function(){return b};var g=function(a,c,d,e,f){f="undefined"!=typeof f?f:!1;var g=function(a){for(var b in a)if(-1!==c.indexOf(a[b].name)&&(d.apply(this,e),f))break};return b.observeHandler(a,g),g},h=function(a,b,c){var d=(b||"").split(",");for(var e in d){var f=d[e].trim().split(" ").map(function(a){return a.trim()}).filter(function(a){return""!=a});if(1==f.length&&(f.push("<<>"),f.push(f[0]),f[0]="val"),f.length>2&&""!=f[2]){var g=(f[1].match(/</g)||[]).length,h=(f[1].match(/>/g)||[]).length,i=2==g?"html":2==h?"js":null;c(function(a,b){var c=["val","html","text"];return{varName:b[2],canRead:g>0,canWrite:h>0,initCopyTo:i,valueFromHTML:function(){return-1!=c.indexOf(b[0])?a[b[0]]():a.attr(b[0])},valueToHTML:function(d){return-1!=c.indexOf(b[0])?a[b[0]](d):(a.attr(b[0],d),void 0)}}}(a,f))}}},i=function(a,c,d){var h=!1,i=(c.attr(b.attr_pfx+"triggers")||"").split(",").map(function(a){return a.trim()}).filter(function(a){return"!"==a?(h=!0,!1):!0}),j=l(a,c.attr(b.attr_pfx+"handler")||"");if(j){var k=g(a,i,j,[a,c]);d.jsChangeHandler=k,h&&(e?f.push({handler:j,args:[a,c]}):j(a,c))}},j=function(a,c,d){c.each(function(){$.each(this.attributes,function(){if(this.specified&&0==this.name.indexOf(b.attr_pfx+"on")){var e=this.value.split("("),f=[];e.length>1&&(f=e[1].split(")")[0].trim().split(",").map(function(a){return a.trim()}));var g=this.name.substr((b.attr_pfx+"on").length);d.ons.hasOwnProperty(g)||(d.ons[g]=[]);var h=function(){l(a,e[0].trim()).apply(this,f)};d.ons[g].push(h),c.on(g,h)}})})};this.bindOne=function(a,e,f,g){g="undefined"!=typeof g?g:h;var k=e.attr(b.attr_pfx+"bind-id");return("undefined"==typeof k||f)&&("undefined"==typeof k&&(k=c++,e.attr(b.attr_pfx+"bind-id",k)),f&&d.hasOwnProperty(k)&&this.clearHandlers(k),d[k]={scope:a,ref_el:e,observeHandlers:[],ons:{change:[]},jsChangeHandler:void 0},g(e,e.attr(b.attr_pfx+"models"),function(c){var f=function(){m(c.varName,c.valueFromHTML(),a)};switch(c.initCopyTo){case"js":f();break;case"html":c.valueToHTML(l(a,c.varName))}if(c.canRead){var g=function(b){for(var d in b)b[d].name==c.varName&&c.valueToHTML(l(a,c.varName))};d[k].observeHandlers.push(g),b.observeHandler(a,g)}c.canWrite&&(d[k].ons.change.push(f),e.on("change",f))}),i(a,e,d[k]),j(a,e,d[k])),k},this.bindHtml=function(a,c,d,e){d="undefined"!=typeof d?d:!0,c="undefined"!=typeof c?c:$("body");var f=[],g=this;return $(c).find("["+b.attr_pfx+"models]").each(function(){f.push(g.bindOne(a,$(this),d,e))}),f},this.fill=function(a){return $(a.el).attr(b.attr_pfx+"models",a.models),$(a.el).attr(b.attr_pfx+"triggers",a.triggers),$(a.el).attr(b.attr_pfx+"handler",a.handler),this.bindOne(a.scope,a.el)};var k=function(a){var b=a.toString();return b=b.substr("function ".length),b=b.substr(0,b.indexOf("(")),b.trim()};this.controllers=function(a){for(var b in a){var c=a[b],d=k(c);this.controller(d,c)}},this.controller=function(a,c){var d=$("["+b.attr_pfx+'controller="'+a+'"]');if(d.length){e=!0;var g=c({}),h=this.bindHtml(g,d);for(var i in f)f[i].handler.apply(null,f[i].args);e=!1,g.hasOwnProperty("init")&&g.init.apply(g,[h])}},this.clearHandlers=function(a){if(-1!=["number","string"].indexOf(a)&&(a=[a]),"object"==typeof a)for(var c in a){var e=a[c],f=d[e].scope,g=d[e].ref_el;for(var h in d[e].observeHandlers){var i=d[e].observeHandlers[h];b.unobserveHandler(f,i)}for(var j in d[e].ons)g.off(j);d[e].jsChangeHandler&&b.unobserveHandler(f,d[e].jsChangeHandler),delete d[e]}};var l=function(a,b){b=b.replace(/\[(\w+)\]/g,".$1"),b=b.replace(/^\./,"");for(var c=b.split(".");c.length;){var d=c.shift();if(!(d in a))return;a=a[d]}return a},m=function(a,b,c){c||(c=data);var d=a.split(/\./);d.length<2?c[d[0]]=b:(c[d[0]]||(c[d[0]]={}),c=c[d.shift()],m(d.join("."),b,c))}}return a});